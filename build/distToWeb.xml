<?xml version="1.0" encoding="UTF-8"?>
<project default="all">
	<taskdef name="exec-listener" classname="ExecListener" />
	<!--taskdef name="jarbundler" classname="net.sourceforge.jarbundler.JarBundler" /-->
	<taskdef name="bundleapp" classname="com.oracle.appbundler.AppBundlerTask"/>
	
	<!--<echo level="info" message="This project depends on property 'eclipse.workspace' (no trailing /) being set in Eclipse|Properties|Ant|Runtime|Properties."/>-->
	<fail message="This project depends on property 'eclipse.workspace' (no trailing /) being set in Eclipse|Properties|Ant|Runtime|Properties.">
	    <condition>
	        <not>
	            <isset property="eclipse.workspace"/>
	        </not>
	    </condition>
	</fail>
	<property name="distName" value="casa"/>
	<property name="capDistName" value="CASA"/>
	
	<property name="projectDir" location="${eclipse.workspace}/${capDistName}"/>
	<property name="buildDir" location="${projectDir}/build"/>
	<property name="distDir" location="${projectDir}/dist"/>
	<property name="distDocDir" location="${distDir}/doc"/>
	<property name="macAppDir" location="${distDir}/mac/app"/>
	<property name="windowsExeDir" location="${distDir}/windows"/>

	<property name="dest" location="/Users/kremer/www-CPSC/${capDistName}" />   <!--to copy to local version of web -->
	<!--<property name="dest" location="/Volumes/kremer.cpsc.ucalgary.ca/public_html/${capDistName}" />  to copy to public version of web -->
	<property name="javadocDest" location="${dest}/javadoc"/>
	<property name="docDest" location="${dest}/doc"/>
	<property name="installDest" location="${dest}/dist"/>

	<property name="manualsDir" location="/Users/kremer/papers/_current/CasaDoc"/>
	
	<property name="launch4j.dir" location="${eclipse.workspace}/AntExtensions/dist" />
	<taskdef name="launch4j"
	    classname="net.sf.launch4j.ant.Launch4jTask"
	    classpath="${launch4j.dir}/launch4j.jar:${launch4j.dir}/xstream.jar" />
	
	<exec-listener onSuccess="true|false">
		<exec dir="${buildDir}" os="Mac OS X" executable="/bin/sh">
			<arg value="-c"/>
			<arg value="rm -Pv ${buildDir}/prompter.sh"/>
		</exec>
	</exec-listener>
	
	<!-- ================================= 
          macrodef: sudo
          WARNING: depends on target "sudopwd", so be sure to add 
          "depends="sudopwd" to every target that uses sudo.
       ================================= -->
	<macrodef name="sudo">
	  <attribute name="command"/>
		<sequential>
			<echo file="${buildDir}/prompter.sh" append="false">#!/bin/bash
				echo ${password}
			</echo>
			<chmod file="${buildDir}/prompter.sh" perm="u+x"/>
			<mkdir dir="${macAppDir}"/>
			<exec dir="${macAppDir}" os="Mac OS X" executable="/bin/sh">
			  <env key="SUDO_ASKPASS" value="${buildDir}/prompter.sh"/>
				<arg value="-c"/>
				<arg value="sudo -A @{command}"/>
			</exec>
			<!--<delete file="${buildDir}/prompter.sh"/>-->
			<exec dir="${buildDir}" os="Mac OS X" executable="/bin/sh">
				<arg value="-c"/>
				<arg value="rm -P ${buildDir}/prompter.sh"/>
			</exec>
		</sequential>
	</macrodef>
	
	<!-- ================================= 
          target: sudopwd              
       ================================= -->
	<target name="sudopwd" description="asks for an sudo password (required to make a .dmg file)" unless="password">
		<input
	    message="Please validate password for sudo"
	    addproperty="password"> 
			<!--<handler type="secure"/>-->
		</input>
		
	</target>

	
	<!-- ================================= 
          target: all              
       ================================= -->
	<target name="all" depends="dist,doc" description="builds all the other targets">
	</target>

	<!-- ================================= 
          target: doc              
       ================================= -->
	<target name="doc" depends="pdfdoc,javadoc" description="builds all the other targets">
	</target>

	<!-- ================================= 
          target: dist              
       ================================= -->
	<target name="dist" depends="distGeneric,distMac,distEclipse,distWindows" description="builds all the other distribution targets">
		
	</target>

	<!-- ================================= 
          target: pdfdoc              
       ================================= -->
	<target name="pdfdoc" description="builds the pdf documentation">
		<copy file="${manualsDir}/CasaUserManual.pdf" todir="../src/${distName}/doc-files" />
		<copy file="${manualsDir}/CasaUserManual.pdf" todir="${javadocDest}/${distName}/doc-files" />
		<copy file="${manualsDir}/CasaUserManual.pdf" todir="${docDest}" />
		<copy file="${manualsDir}/CasaHowTo.pdf" todir="../src/${distName}/doc-files" />
		<copy file="${manualsDir}/CasaHowTo.pdf" todir="${javadocDest}/${distName}/doc-files" />
		<copy file="${manualsDir}/CasaHowTo.pdf" todir="${docDest}" />
	</target>

	<!-- ================================= 
          target: javadoc              
       ================================= -->
	<target name="javadoc" description="builds the javadoc documentation">
	  <ant antfile="javadoc.xml" />
		<antcall target="zipjavadoconly" />
	</target>
	
	<!-- ================================= 
          target: zipjavadoconly
       ================================= -->
	<target name="zipjavadoconly" description="zip">
			<zip destfile="${installDest}/doc/${distName}doc.zip" basedir="${javadocDest}" excludes="*.jar" level="9" />
	</target>

	<!-- ================================= 
          target: distGeneric
       ================================= -->
	<target name="distGeneric" description="builds distribution binary and source-code-included jars" depends="distGenericBin,distGenericSrc">
	</target>
	
	<target name="distGenericBin" description="builds distribution binary jar" depends="setProperties">
		<!-- build a non-source jar -->
    <jar destfile="${distDir}/${distName}.jar" filesetmanifest="skip">
         <manifest>
             <attribute name="Main-Class" value="CASA"/>
             <attribute name="Class-Path" value="."/>
      		   <attribute name="casa-build-time" value="${build.time}"/>
         </manifest>
         <fileset dir="${eclipse.workspace}/CASA/bin"/>
         <fileset dir="${eclipse.workspace}/CASA/dataFiles"/>
    	   <fileset file="${eclipse.workspace}/CASA/scripts/sc2.lisp"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/abcl.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/commons-codec-1.3.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/betterbeansbinding-1.3.0-all.jar"/>
    	   <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/forms-1.3.0.jar"/>
    	   <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/miglayout15-swing.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/xercesImpl-2.7.1.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/HermiT.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/org.semanticweb.HermiT.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/owlapi-distribution-3.4.3-bin.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/jdom.jar"/>
         <zipfileset excludes="META-INF/*.SF" src="${junit}"/>
         <zipfileset excludes="META-INF/*.SF" src="${core}"/>
    </jar>
		<copy file="${distDir}/${distName}.jar" todir="${installDest}/nosource" />
	</target>
		
	<target name="distGenericSrc" description="builds distribution source-included jar" depends="setProperties">
		<!-- build a source-included jar -->
	    <jar destfile="${distDir}/${distName}-src.jar" filesetmanifest="skip">
	         <manifest>
	             <attribute name="Main-Class" value="CASA"/>
	             <attribute name="Class-Path" value="."/>
        		   <attribute name="casa-build-time" value="${build.time}"/>
	         </manifest>
	         <fileset dir="${eclipse.workspace}/CASA/bin"/>
	         <fileset dir="${eclipse.workspace}/CASA/dataFiles"/>
           <fileset dir="${eclipse.workspace}/CASA/src"/>
   	       <fileset file="${eclipse.workspace}/CASA/scripts/sc2.lisp"/>
	         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/abcl.jar"/>
	         <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/commons-codec-1.3.jar"/>
           <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/betterbeansbinding-1.3.0-all.jar"/>
   	       <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/forms-1.3.0.jar"/>
   	       <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/miglayout15-swing.jar"/>
           <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/xercesImpl-2.7.1.jar"/>
           <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/HermiT.jar"/>
           <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/org.semanticweb.HermiT.jar"/>
           <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/owlapi-distribution-3.4.3-bin.jar"/>
           <zipfileset excludes="META-INF/*.SF" src="${eclipse.workspace}/CASA/jars/jdom.jar"/>
	         <zipfileset excludes="META-INF/*.SF" src="${junit}"/>
	         <zipfileset excludes="META-INF/*.SF" src="${core}"/>
	  </jar>
		<copy file="${distDir}/${distName}-src.jar" tofile="${installDest}/source/${distName}.jar" />

	</target>
	
	<!-- ================================= 
          target: distEclipse              
       ================================= -->
	<target name="distEclipse">
		<!-- build an eclipse project in a zip file -->
		<zip destfile="${installDest}/eclipse/${distName}.zip" basedir="${eclipse.workspace}/${capDistName}" excludes="**/*.log,dist/,launch/,scripts/,bin/**,MacOS/,nullcasa/,other/" level="9" />
	</target>
	
	
	<!-- ================================= 
          target: distMac              
       ================================= -->
	<target name="distMac" depends="distGenericBin,sudopwd">
		<!-- build a mac .app file -->
		<!--<mkdir dir="${macAppDir}"/>-->
		<sudo command="rm -Rf ${macAppDir}/${distName}.app"/>
		<!--<jarbundler dir="${macAppDir}" !!!jarbundler unsupported after Java 6 
		             name="${distName}"
		             mainclass="CASA"
		             jar="../dist/${distName}.jar" 
								 icon="../dataFiles/images/customGraphics/casa.icns"
		             splashfile="$JAVAROOT/casa.png"
								 infostring="Collaborative Agent System Architecture"
								 vmoptions="-Dapple.laf.useScreenMenuBar=true -Dcom.apple.mrj.application.apple.menu.about.name=CASA -Xdock:name=CASA -Xdock:icon=Protege.icns">
		             <javafileset dir="../dataFiles/images/customGraphics" id="splashfile">
                     <include name="casa.png"/>
								 </javafileset>
		</jarbundler-->
		<bundleapp outputdirectory="${macAppDir}"
			name="${capDistName}"
			displayname="${capDistName}"
			identifier="org.ksg.${distName}"
			icon="../dataFiles/images/customGraphics/casa.icns"
			copyright="Knowledge Science Group"
			mainclassname="CASA">
			<classpath file="../dist/${distName}.jar"/>
			<option value="-Dapple.laf.useScreenMenuBar=true -Dcom.apple.mrj.application.apple.menu.about.name=CASA -Xdock:name=CASA -Xdock:icon=casa.icns"/>
		</bundleapp>
		<copy force="true" file="../dataFiles/images/customGraphics/casa.icns" tofile="${macAppDir}/CASA.app/Contents/Resources/GenericApp.icns" />
		
		
		<sudo command="chown -R root ${distName}.app"/>

		<!-- build a mac install (.pkg) file -->
		<exec dir="${macAppDir}" os="Mac OS X" executable="/bin/sh">
			<arg value="-c"/>
			<arg value="rm -R ${macAppDir}/${distName}.mpkg"/>
		</exec>
		<echo>Building .mpkg file </echo>
		<!--exec dir="${macAppDir}" os="Mac OS X" executable="/Applications/Xcode Tools/PackageMaker.app/Contents/MacOS/PackageMaker">
			<arg value="- -verbose"/>
			<arg value="- -install-to"/>
			<arg value="/Applications"/>
			<arg value="- -doc"/>
			<arg value="${buildDir}/${distName}.pmdoc"/>
			<arg value="- -out"/>
			<arg value="${macAppDir}/${distName}.pkg"/>
		</exec-->
		<exec dir="${macAppDir}" os="Mac OS X" executable="/usr/local/bin/packagesbuild">
		<arg value="${buildDir}/mac/${capDistName}.pkgproj"/>
		</exec>
		<!-- put the .pkg file in a .dmg file-->
		<exec dir="${macAppDir}" os="Mac OS X" executable="/bin/sh">
			<arg value="-c"/>
			<arg value="rm -R dmg"/>
		</exec>
		<echo>Building .dmg file </echo>
		<exec dir="${macAppDir}" os="Mac OS X" executable="/bin/sh">
			<arg value="-c"/>
			<arg value="mkdir -p dmg"/>
		</exec>
		<exec dir="${macAppDir}" os="Mac OS X" executable="/bin/sh">
			<arg value="-c"/>
			<arg value="cp -pR ${macAppDir}/${distName}.mpkg dmg"/>
		</exec>
		<exec dir="${macAppDir}" os="Mac OS X" executable="/bin/sh">
			<arg value="-c"/>
			<arg value="hdiutil create ${macAppDir}/${distName}.dmg -volname ${distName} -ov -fs HFS+ -srcfolder dmg"/>
		</exec>
		<copy file="${macAppDir}/${distName}.dmg" todir="${installDest}/mac" />
		
	</target>
	
	<!-- ================================= 
          target: distWindows              
       ================================= -->
	<target name="distWindows" >
		<!-- launch4j for windows executable -->
		<launch4j>
		  <config headerType="gui" 
		  	outfile="${windowsExeDir}/${distName}.exe"
		    icon="${projectDir}/dataFiles/images/customGraphics/casa.ico"
		  	jar="${distDir}/${distName}.jar" >
		    <var>SETTINGS="%HomeDrive%%HomePath%\\settings.ini"</var>
		    <classPath mainClass="CASA">
		        <cp>.</cp>
		    </classPath>
		    <jre minVersion="1.6.0">
		        <opt>-Dlaunch4j.exedir="%EXEDIR%"</opt>
		        <opt>-Dlaunch4j.exefile="%EXEFILE%"</opt>
		    </jre>
		  	<!-- splash causes the windows .exe to fail for some reason -->
		  	<splash
		  		file="${projectDir}/dataFiles/images/customGraphics/casa.bmp" 
		  		waitForWindow="true" 
		  		timeout="60"
		  		timeoutErr="true" />
		  	
		  </config>
		</launch4j>
		<!-- for some reason the .exe doesn't seem to work when run through a zip file...>
		<zip destfile="${windowsExeDir}/${distName}.zip" basedir="${windowsExeDir}" includes="${distName}.exe" />
		<exec dir="${windowsExeDir}" os="Mac OS X" executable="/bin/sh">
			<arg value="-c"/>
			<arg value="rm -Pv ${windowsExeDir}/${distName}.exe"/>
		</exec>
		-->
		<copy file="${windowsExeDir}/${distName}.exe" todir="${installDest}/windows" />
	</target>


	<target name="getOS">
  	<condition property="osx">
  		<os family="mac"/>
  	</condition>
  	<condition property="win">
  		<os family="windows"/>
  	</condition>
	</target>
	
	<target name="setProperties" depends="macProp,windowsProp">
	  <tstamp>
	      <format property="build.time" pattern="yyyy/MMM/dd HH:mm"/>
	  </tstamp>
	</target>
	
	<target name="macProp" if="osx" depends="getOS">
  	<property name="plugins" location="/Applications/eclipse 3.7/plugins"/>
		<property name="junit" location="${plugins}/org.junit_4.8.2.v4_8_2_v20110321-1705/junit.jar"/>
		<property name="core" location="${plugins}/org.hamcrest.core_1.1.0.v20090501071000.jar"/>
	</target>
	
	<target name="windowsProp" if="win" depends="getOS">
  	<property name="plugins" location="C:/Program Files/eclipse/plugins"/>
		<property name="junit" location="${plugins}/org.junit_4.8.2.v4_8_2_v20110321-1705/junit.jar"/>
		<property name="core" location="${plugins}/org.hamcrest.core_1.1.0.v20090501071000.jar"/>
	</target>


</project>
